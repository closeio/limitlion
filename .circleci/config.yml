version: 2.1

executors:
  py27:
    docker:
      - image: python:2.7
      - image: redis:3.2
  py36:
    docker:
      - image: python:3.5
      - image: redis:3.2
  py37:
    docker:
      - image: python:3.7
      - image: redis:3.2
  py38:
    docker:
      - image: python:3.8
      - image: redis:3.2

jobs:
  test:
    working_directory: /home/ubuntu/
    executor:
      name: py27
    steps:
      - checkout
      - prepare
        run:
          name: Prepare environment
          command: |
            apt-get update
            apt-get install -y lua5.1 luarocks
            pip install flake8 flake8-docstrings flake8-polyfill pep8 pep8-naming isort
            pip install --no-deps -r requirements.txt
            pip install -r requirements_test.txt
            luarocks install luacheck
      - lint
        run:
          name: Run flake8
          command: |
            flake8
            isort -rc -c .
            luacheck --max-cyclomatic-complexity 11 --globals redis ARGV KEYS -r limitlion
      - run:
          name: Setup Code Climate
          command: |
            apt-get update
            apt-get install -y curl git
            curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
            chmod +x ./cc-test-reporter
      - run:
          name: Run tests
          command: |
            PYTHONPATH=. pytest --cov=limitlion --cov-report=xml

workflows:
  workflow:
    jobs:
      - test

